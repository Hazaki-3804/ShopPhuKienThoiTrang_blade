<html>
    <head>
        <title>Document</title>
        Bootstrap
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    </head>
    <body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-4">
          <h4 class="fw-bold text-center mb-3">Xác nhận email</h4>
          <p class="text-center text-muted mb-4">
            Mã xác nhận đã được gửi đến<br>
            <strong class="text-dark">{{ $email }}</strong><br>
            (hiệu lực 60 giây)
          </p>

          @if ($errors->any())
            <div class="alert alert-danger py-2">
              <ul class="mb-0">
                @foreach ($errors->all() as $error)
                  <li>{{ $error }}</li>
                @endforeach
              </ul>
            </div>
          @endif

          @if (session('status'))
            <div class="alert alert-success py-2">{{ session('status') }}</div>
          @endif

          <form method="POST" action="{{ route('verify.email.submit') }}" id="verify-form" autocomplete="off">
            @csrf
            <input type="hidden" name="email" value="{{ $email }}">
            <input type="hidden" id="code" name="code">

            <!-- 6 ô nhập mã -->
            <div class="otp-inputs d-flex justify-content-between mb-4">
              @for ($i = 0; $i < 6; $i++)
                <input type="text" maxlength="1" inputmode="numeric"
                  class="form-control form-control-lg text-center otp-box"
                  data-index="{{ $i }}">
              @endfor
            </div>

            <!-- Nút xác nhận + gửi lại -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg flex-grow-1 fw-semibold" id="submit-btn">
                Xác nhận (<span id="countdown">60</span>s)
              </button>
              <button type="button" class="btn btn-outline-secondary btn-lg" id="resend-btn" disabled>Gửi lại mã</button>
            </div>

            <div id="expired-msg" class="text-danger text-center mt-3" style="display:none;">
              Mã đã hết hạn. Vui lòng gửi lại mã để tiếp tục.
            </div>

            <div class="text-center mt-3">
              <a href="{{ route('register') }}" class="text-decoration-none text-muted small">
                ↩ Đăng ký lại
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .otp-box {
    width: 48px;
    height: 56px;
    font-size: 1.5rem;
    border-radius: 0.75rem;
    border: 2px solid #dee2e6;
    transition: all 0.2s;
  }
  .otp-box:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 3px rgba(13,110,253,.25);
  }
  .otp-inputs { gap: 0.5rem; }
</style>
<script>
(() => {
  const inputs = document.querySelectorAll('.otp-box');
  const hiddenInput = document.getElementById('code');
  const countdownEl = document.getElementById('countdown');
  const submitBtn = document.getElementById('submit-btn');
  const resendBtn = document.getElementById('resend-btn');
  const expiredMsg = document.getElementById('expired-msg');

  let expiresAt = {{ (int)($expiresAt ?? (time() + 60)) }} * 1000;
  let timerId;

  // --- OTP input logic ---
  inputs.forEach((input, idx) => {
    input.addEventListener('input', e => {
      const val = e.target.value.replace(/\D/g, '');
      e.target.value = val;
      if (val && idx < inputs.length - 1) inputs[idx + 1].focus();
      updateHidden();
    });
    input.addEventListener('keydown', e => {
      if (e.key === 'Backspace' && !input.value && idx > 0) {
        inputs[idx - 1].focus();
      }
    });
    input.addEventListener('paste', e => {
      e.preventDefault();
      const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
      if (pasted.length === 6) {
        [...pasted].forEach((ch, i) => { if (inputs[i]) inputs[i].value = ch; });
        updateHidden();
        inputs[5].focus();
      }
    });
  });

  function updateHidden() {
    hiddenInput.value = Array.from(inputs).map(i => i.value).join('');
  }

  // --- Countdown logic ---
  function startCountdown() {
    clearTimeout(timerId);
    function tick() {
      const now = Date.now();
      const left = Math.max(0, Math.floor((expiresAt - now) / 1000));
      countdownEl.textContent = left;
      if (left <= 0) {
        submitBtn.disabled = true;
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-danger');
        resendBtn.disabled = false;
        expiredMsg.style.display = 'block';
        return;
      }
      timerId = setTimeout(tick, 1000);
    }
    submitBtn.disabled = false;
    submitBtn.classList.add('btn-primary');
    submitBtn.classList.remove('btn-danger');
    resendBtn.disabled = true;
    expiredMsg.style.display = 'none';
    tick();
  }

  startCountdown();

  // --- Resend logic ---
  resendBtn.addEventListener('click', () => {
    resendBtn.disabled = true;
    resendBtn.textContent = 'Đang gửi...';

    // Gửi AJAX yêu cầu gửi lại mã
    fetch("{{ route('verify.email.resend') }}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ email: "{{ $email }}" })
    })
    .then(res => res.json())
    .then(data => {
      resendBtn.textContent = 'Gửi lại mã';
      if (data.success) {
        expiresAt = Date.now() + 60000;
        startCountdown();
        alert('✅ Mã xác nhận mới đã được gửi đến email của bạn!');
      } else {
        alert('❌ Không thể gửi lại mã. Vui lòng thử lại sau.');
        resendBtn.disabled = false;
      }
    })
    .catch(() => {
      resendBtn.textContent = 'Gửi lại mã';
      resendBtn.disabled = false;
      alert('⚠️ Lỗi kết nối, vui lòng thử lại.');
    });
  });
})();
</script>

    </body>
</html>